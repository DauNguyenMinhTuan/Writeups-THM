# Nmap Live Host Discovery

## Description

Learn how to use Nmap to discover live hosts using ARP scan, ICMP scan, and TCP/UDP ping scan.
* Category: Walkthrough

## Introduction

This room explains the steps that Nmap carries out to discover the systems that are online before port-scanning. This stage is crucial because trying to port-scan offline systems will only waste time and create unnecessary noise on the network.

## Subnetworks

A *network segment* is a group of computers connected using a shared medium. The medium can be the Ethernet switch or WiFi access point. In an IP network, a subnetwork is usually the equivalent of one or more network segments connected together and configured to use the same router. The network segment refers to a physical connection, while a subnetwork refers to a logical connection.

A subnetwork, or simply a subnet, has its own IP address range and is connected to a more extensive network via a router. There might be a firewall enforcing security policies depending on each network.

As part of active reconnaissance, we want to discover more information about a group of hosts or about a subnet. If we are connected to the same subnet, we would expect our scanner to rely on ARP (Address Resolution Protocol) queries to discover live hosts. An ARP query aims to get the hardware address (MAC address) so that communication over the link-layer becomes possible. However, we can use this to infer that the host is online.

Suppose we are connected to a subnet different from the subnet of the target system(s). In that case, all packets generated by our scanner will be routed via the default gateway (router) to reach the systems on another subnet. However, the ARP queries won’t be routed and hence cannot cross the subnet router. ARP is a link-layer protocol, and ARP packets are bound to their subnet.

## Discovering Live Hosts

To discover live hosts, we can use protocols such as ARP, ICMP, TCP and UDP. Here are how these protocols are used:
* ARP has one purpose: sending a frame to the broadcast address on the network segment and asking the computer with a specific IP address to respond by providing its MAC (hardware) address.
* ICMP has many types. ICMP ping uses Type 8 (Echo) and Type 0 (Echo Reply). If we want to ping a system on the same subnet, an ARP query should precede the ICMP Echo.
* Although TCP and UDP are transport layers, for network scanning purposes, a scanner can send a specially-crafted packet to common TCP or UDP ports to check whether the target will respond. This method is efficient, especially when ICMP Echo is blocked.

## Nmap Host Discovery Using ARP

It is essential to avoid wasting our time port-scanning an offline host or an IP address not in use. There are various ways to discover online hosts. When no host discovery options are provided, Nmap follows the following approaches to discover live hosts:
1. When a privileged user tries to scan targets on a local network (Ethernet), Nmap uses ARP requests. A privileged user is `root` or a user who belongs to `sudoers` and can run `sudo`.
2. When a privileged user tries to scan targets outside the local network, Nmap uses ICMP echo requests, TCP ACK (Acknowledge) to port 80, TCP SYN (Synchronize) to port 443, and ICMP timestamp request.
3. When an unprivileged user tries to scan targets outside the local network, Nmap resorts to a TCP 3-way handshake by sending SYN packets to ports 80 and 443.

Nmap, by default, uses a ping scan to find live hosts, then proceeds to scan live hosts only. If we want to use Nmap to discover online hosts without port-scanning the live systems, we can issue `nmap -sn TARGETS`.

ARP scan is possible only if we are on the same subnet as the target systems. On an Ethernet (802.3) and WiFi (802.11), we need to know the MAC address of any system before we can communicate with it. The MAC address is necessary for the link-layer header. The header contains the source MAC address and the destination MAC address among other fields.

To get the MAC address, the OS sends an ARP query. A host that replies to ARP queries is up. The ARP query only works if the target is on the same subnet as ourself, i.e., on the same Ethernet/WiFi. We should expect to see many ARP queries generated during a Nmap scan of a local network. If we want Nmap only to perform an ARP scan without port-scanning, we can use `nmap -PR -sn TARGETS`, where `-PR` indicates that we only want an ARP scan.

Another scanner that can perform ARP scans is `arp-scan`. One popular choice is `arp-scan --localnet` or simply `arp-scan -l`. This command will send ARP queries to all valid IP addresses on our local networks.

## Nmap Host Discovery Using ICMP

We can ping every IP address on a target network and see who would respond to our ping (ICMP Type 8/Echo) requests with a ping reply (ICMP Type 0).

Although this would be the most straightforward approach, it is not always reliable. Many firewalls block ICMP echo; new versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default.

Because ICMP echo requests tend to be blocked, we might also consider ICMP Timestamp or ICMP Address Mask requests to tell if a system is online. Nmap uses timestamp request (ICMP Type 13) and checks whether it will get a Timestamp reply (ICMP Type 14). Adding the `-PP` option tells Nmap to use ICMP timestamp requests.

Similarly, Nmap uses address mask queries (ICMP Type 17) and checks whether it gets an address mask reply (ICMP Type 18). This scan can be enabled with the option `-PM`.

## Nmap Host Discovery Using TCP and UDP

### TCP SYN Ping

We can send a packet with the **SYN (Synchronize)** flag set to a TCP port, 80 by default, and wait for a response. An open port should reply with a **SYN/ACK (Acknowledge)**; a closed port would result in an **RST (Reset)**. In this case, we only check whether we will get any response to infer whether the host is up. The specific state of the port is not significant here.

Privileged users can send TCP SYN packets and don't need to complete the TCP 3-way handshake even if the port is open. Unprivileged users have no choice but to complete the 3-way handshake if the port is open.

### TCP ACK Ping

This sends a packet with an **ACK** flag set. We must be running Nmap as a privileged user to be able to accomplish this. If we try it as an unprivileged user, Nmap will attempt a 3-way handshake.

### UDP Ping

Finally, we can use UDP to discover if the host is online. Contrary to TCP SYN ping, sending a UDP packet to an open port is not expected to lead to any reply. However, if we send a UDP packet to a closed UDP port, we expect to get an **ICMP port unreachable packet**; this indicates that the target system is up and available.

### Masscan

On a side note, Masscan uses a similar approach to discover the available systems. However, to finish its network scan quickly, Masscan is quite aggressive with the rate of packets it generates.

## Using Reverse-DNS Lookup

Nmap’s default behaviour is to use reverse-DNS online hosts. Because the hostnames can reveal a lot, this can be a helpful step. However, if we don't want to send such DNS queries, we use `-n` to skip this step.

By default, Nmap will look up online hosts; however, we can use the option `-R` to query the DNS server even for offline hosts. If we want to use a specific DNS server, we can add the `--dns-servers DNS_SERVER` option.